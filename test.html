<head>
    <title>QR reader Demo</title>
    <meta name="viewport" content="width=device-width, user-scalable=no" />
    <style>
        video,canvas{
            float:left
        }

    </style>
</head>


<body>
    <video autoplay="autoplay" muted="muted" playsinline></video>
    <canvas id="in" width="640" height="480"></canvas>
    <canvas id="out" width="640" height="480"></canvas>
    <script>

        var stream_g = null
        var video = document.getElementsByTagName('video')[0]
        var ctx_in = document.getElementById('in').getContext('2d')
        var ctx_out = document.getElementById('out').getContext('2d')
        
        navigator.mediaDevices.getUserMedia({video: true, audio: false})
        .then((stream)=>{
            video.srcObject = stream
            setInterval(function(){
                ctx_in.drawImage(video, 0, 0)
                var data_in = ctx_in.getImageData(0, 0, 640, 480)
                var len = data_in.data.length
                var data_out = ctx_out.createImageData(640,480)
                ctx_out.putImageData(data_out, 0, 0)
            }, 30)
        })
        .catch(function(err){console.log(err)})

        function grayScale(imageData){
            var length_in = imageData.data.length
            var langth_out = imageData.width * imageData.height
            var channels = length_in / length_out

            if(channels < 4) return null

            var res = new Uint8ClampedArray(length_in)
            res.step = imageData.width
            for(var i = 0; i < length_in; i += channels){
                res.data[i] = Math.round(0.3 * data_in.data[i] + 0.59 * data_in.data[i + 1] + 0.11 * data_in.data[i + 2])
            }

            return res
        }

        function canny(img){

        }

    </script>
</body>