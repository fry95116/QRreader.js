<head>
    <title>QR reader Demo</title>
    <meta name="viewport" content="width=device-width, user-scalable=no" />

    <link rel="manifest" href="manifest.json" />
    <link rel="stylesheet" type="text/css" href="main.css">
    <!-- 截至ios11.3，暂时不支持manifest.icons -->
    <link rel="apple-touch-icon" href="./e.png" type="image/png" />
    <link rel="icon" href="./e.png" type="image/png" />
    <style>
        .absolute-center{
            position: absolute;
            transform: translateX(-50%) translateY(-50%);
            top: 50%;
            left: 50%;
        }

        .QRreader-mask{
            position: fixed;
            left: 0px;
            top: 0px;
            width: 100%;
            height: 100%;
            background-color: black;
            overflow: hidden;
        }
        
        .QRreader-mask video{
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            position: absolute;
        }

        .QRreader-mask .aperture{
            width: 50%;
            height: 0;
            padding-bottom: 50%;
            border: 2px solid white;
        }

        .QRreader-mask .aperture .scan-line{
            margin:0;
            border: 2px solid white;
            animation: scan 1s ease-in-out infinite alternate;
        }
        
        .QRreader-mask .btn-switch{
            position: absolute;
            width: 40px;
            height: 40px;
            border: 3px solid white;
            border-radius: 50%;
            right: 20px;
            bottom: 20px;
        }

        @keyframes scan{
            from{margin-top:0%;}
            to{margin-top:100%;}
        }
    </style>
</head>

<body>
    <div class="revision">Revision 8</div>
    <img src="pwa-fonts.png">
    <div class="main-text">

    </div>
    <div>
        <label class="btn-scanner" for="qrcode-capture"></label>
        <input id="qrcode-capture" type="file" accept="image/*" multiple>
    </div>
    <div class="network-message">
        Network:
        <span id="network-status" class="">Good</span>
    </div>
    <div class="QRreader-mask">
        <video class="absolute-center" autoplay="autoplay" muted="muted" playsinline></video>
        <div class="absolute-center aperture" >
            <hr class="scan-line">
        </div>
        <bitton class="btn-switch" onclick="switchDevice()"></bitton>
    </div>
    <script src="QRreader.js"></script>
    <script type="text/javascript">
        // init service worker
        if (navigator.serviceWorker != null) {
            navigator.serviceWorker.register('sw.js')
                .then(function (registration) {
                    console.log('Registered events at scope: ', registration.scope);
                });
        }

        // get network info
        var statusEl = document.querySelector('#network-status')
        if (!navigator.onLine) {
            statusEl.classList = ['is-offline']
            statusEl.innerText = 'Offline'
        }

        // for some reason safari on mac can debug ios safari page but not ios home screen web apps 
    
        var msg = document.querySelector('.main-text')
        msg.innerHTML += getSupportInfo().join('<br>')

        function getSupportInfo(){
            return [
                'navigator : ' + typeof navigator,
                'MediaDevices:' + typeof MediaDevices,
                'navigator.mediaDevices: ' + typeof navigator.mediaDevices,
                'navigator.getUserMedia: ' + typeof navigator.getUserMedia,
                'navigator.webkitGetUserMedia' + typeof navigator.webkitGetUserMedia
            ]
        }

        var mediaDevices = getMediaDevices()
        if (mediaDevices == null) {
            alert('mediaDevices not supported!')
        }
        else {
            mediaDevices.enumerateDevices()
                .then(function (devices) {
                    devices.forEach(function (device) {
                        msg.innerHTML += device.kind + ': ' + device.label + ' id = ' + device.deviceId + '<br>';
                    });
                    window.cameras = getCameras(devices)
                    window.screen = document.querySelector('.QRreader-mask video')
                    window.idx_cur = 0
                    setCamera(cameras, window.idx_cur, screen)
                })

        }

        function getCameras(devices){
            res = []
            for(idx in devices){
                device = devices[idx]
                if(device.kind === 'videoinput'){
                    res.push(device)
                }
            }
            return res
        }

        function setCamera(cameras, idx, screen){

            if(cameras.length > 0){
                idx = idx % cameras.length

                var constraints = {
                    video: {
                        facingMode: { exact: "environment" } 
                    },
                    audio: false
                };

                navigator.mediaDevices.getUserMedia(constraints)
                    .then(function (stream) {
                        screen.srcObject = stream;
                    })
                    .catch(function(err) {
                        console.log("Error occurred ", err);
                    });
            }
            return idx

        }

        function switchDevice(){
            // alert('test')
            // supportConstraints = navigator.mediaDevices.getSupportedConstraints()
            // for (k in supportConstraints){
            //     alert(k)
            // }
            var idx = window.idx_cur
            var cameras = window.cameras
            var screen = window.screen
            window.idx_cur = setCamera(cameras, idx, screen) + 1
        }
        // function getCameras(mediaDevices) {
        //     return new Promise(function (resolve, reject) {
        //         if(!mediaDevices.enumerateDevices){
        //             reject(new Error('enumerateDevices() not supported.'))
        //         }
        //         else{
        //             mediaDevices.enumerateDevices()
        //                 .then(function (devices) {
        //                     var res = []
        //                     devices.forEach(function (device) {
        //                         // device.kind可能的值：'videoinput', 'audioinput'
        //                         if (device.kind == 'videoinput')
        //                             res.append(device)
        //                     });
        //                     resolve(res)
        //                 })
        //                 .catch(reject)
        //         }
        //     })
        // }
    </script>
</body>